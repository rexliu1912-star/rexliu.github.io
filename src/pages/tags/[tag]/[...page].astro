---
import { render } from "astro:content";
import type { GetStaticPaths, InferGetStaticPropsType } from "astro";
import { getAllPosts, getTagMeta, getUniqueTags } from "@/data/post";
import PageLayout from "@/layouts/Base.astro";
import { collectionDateSort } from "@/utils/date";

export const getStaticPaths = (async ({ paginate }) => {
	const allPosts = await getAllPosts();
	const sortedPosts = allPosts.sort(collectionDateSort);
	const uniqueTags = getUniqueTags(sortedPosts);

	return uniqueTags.flatMap((tag) => {
		const postsWithTag = sortedPosts.filter((post) => post.data.tags.includes(tag));
		return paginate(postsWithTag, {
			pageSize: 99,
			params: { tag },
		});
	});
}) satisfies GetStaticPaths;

type Props = InferGetStaticPropsType<typeof getStaticPaths>;

const { page } = Astro.props as Props;
const { tag } = Astro.params;
const tagMeta = await getTagMeta(tag);

const TagContent = tagMeta ? (await render(tagMeta)).Content : null;

const meta = {
	description: tagMeta?.data.description ?? `View all posts with the tag - ${tag}`,
	title: tagMeta?.data.title ?? `Posts about ${tag}`,
};

function formatTagPageDate(date: Date) {
	return date
		.toLocaleDateString("en-US", {
			month: "short",
			day: "numeric",
			year: "numeric",
		})
		.replace(",", "");
}
---

<PageLayout meta={meta}>
	{/* 顶部导航：使用与文章详情页一致的 Back 样式 */}
	<div class="mb-12 flex items-center gap-4">
		<a
			class="flex items-center gap-1 font-serif text-sm text-gray-500 transition-colors hover:text-[#8953d1] dark:text-gray-400 dark:hover:text-[#a175e8]"
			href="/posts/"
		>
			<span>&lt;</span>
			<span>Back</span>
		</a>

		<h1 class="font-serif text-3xl font-bold capitalize dark:text-white">
			<span class="text-gray-400">#</span>{tagMeta?.data.title ?? tag}
		</h1>
	</div>

	{
		(tagMeta?.data.description || TagContent) && (
			<div class="prose prose-sm dark:prose-invert mb-12 max-w-none font-serif text-gray-600 italic dark:text-gray-300">
				{tagMeta?.data.description && <p>{tagMeta.data.description}</p>}
				{TagContent && <TagContent />}
			</div>
		)
	}

	<div class="grid sm:grid-cols-[3fr_1fr] sm:gap-x-12">
		<div>
			<ul class="space-y-6 text-start">
				{
					page.data.map((p) => (
						<li class="flex flex-col">
							<div class="flex items-baseline justify-between gap-x-4">
								<a
									href={`/posts/${p.id}/`}
									class="font-serif text-xl font-medium text-black decoration-[#8953d1]/30 underline-offset-4 transition-colors hover:text-[#8953d1] hover:underline hover:decoration-[#8953d1] dark:text-white dark:hover:text-[#a175e8] dark:hover:decoration-[#a175e8]"
								>
									{p.data.title}
								</a>

								<time
									datetime={p.data.publishDate.toISOString()}
									class="shrink-0 font-serif text-xs text-gray-400"
								>
									{formatTagPageDate(p.data.publishDate)}
								</time>
							</div>
						</li>
					))
				}
			</ul>
		</div>

		<aside class="hidden sm:block">
			<div
				class="border-l border-dashed border-gray-200 pl-4 sm:sticky sm:top-24 dark:border-gray-700"
			>
				<p class="font-serif text-xs text-gray-400 italic">
					Currently viewing all entries tagged with "{tag}".
				</p>
			</div>
		</aside>
	</div>
</PageLayout>

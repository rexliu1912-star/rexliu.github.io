---
import type { CollectionEntry } from "astro:content";
import type { GetStaticPaths, Page } from "astro";
import { getAllPosts, groupPostsByYear } from "@/data/post";
import PageLayout from "@/layouts/Base.astro";
import { collectionDateSort } from "@/utils/date";

export const getStaticPaths = (async ({ paginate }) => {
	const MAX_POSTS_PER_PAGE = 99;
	const allPosts = await getAllPosts();
	const allPostsByDate = allPosts.sort(collectionDateSort);

	const tagCounts = allPosts.reduce<{ [key: string]: number }>((acc, post) => {
		post.data.tags?.forEach((tag) => {
			acc[tag] = (acc[tag] || 0) + 1;
		});
		return acc;
	}, {});

	const uniqueTagsWithCounts = Object.entries(tagCounts)
		.sort((a, b) => b[1] - a[1])
		.slice(0, 15);

	return paginate(allPostsByDate, {
		pageSize: MAX_POSTS_PER_PAGE,
		props: { uniqueTagsWithCounts },
	});
}) satisfies GetStaticPaths;

interface Props {
	page: Page<CollectionEntry<"post">>;
	uniqueTagsWithCounts: [string, number][];
}

const { page, uniqueTagsWithCounts } = Astro.props;

const meta = {
	description: "Read my full archive of posts organized by year.",
	title: "Archive",
};

const groupedByYear = groupPostsByYear(page.data);
const descYearKeys = Object.keys(groupedByYear).sort((a, b) => +b - +a);
---

<PageLayout meta={meta}>
	<div class="mb-12">
		<h1 class="font-serif text-3xl font-bold text-black dark:text-white">Archive</h1>
	</div>

	<div class="grid sm:grid-cols-[3fr_1fr] sm:gap-x-12 sm:gap-y-16">
		<div>
			{
				descYearKeys.map((yearKey) => (
					<section class="mb-12">
						<h2 class="mb-6 border-b border-dashed border-gray-200 pb-2 font-serif text-sm font-bold tracking-widest text-gray-400 uppercase dark:border-zinc-700">
							{yearKey}
						</h2>

						<ul class="space-y-6 text-start">
							{groupedByYear[yearKey]?.map((p) => (
								<li class="flex flex-col">
									<div class="flex items-baseline justify-between gap-x-4">
										<a
											href={`/posts/${p.id}/`}
											class="font-serif text-xl font-medium text-black decoration-gray-400 underline-offset-4 hover:underline dark:text-white dark:decoration-zinc-500"
										>
											{p.data.title}
										</a>
										<time class="shrink-0 font-mono text-xs text-gray-400 dark:text-zinc-500">
											{p.data.publishDate.toLocaleDateString("en-US", {
												month: "short",
												day: "numeric",
											})}
										</time>
									</div>
								</li>
							))}
						</ul>
					</section>
				))
			}
		</div>

		<aside class="self-start sm:sticky sm:top-24">
			<h2
				class="mb-4 flex items-center gap-2 font-serif text-lg font-bold text-black dark:text-white"
			>
				Tags
			</h2>
			<ul class="flex flex-wrap gap-x-2 gap-y-3">
				{
					uniqueTagsWithCounts.map(([tag, count]) => (
						<li>
							<a
								class="group flex items-center gap-x-1.5 rounded-md bg-[#FFF8EB] px-2 py-1 transition-all hover:bg-[#8953d1] dark:bg-[#1a1a1a]"
								href={`/tags/${tag}/`}
							>
								{/* ğŸ”´ é¦–å­—æ¯å¤§å†™ + è¡¬çº¿æ–œä½“ + å“ç‰Œç´« */}
								<span class="font-serif text-xs font-medium text-[#8953d1] capitalize italic transition-colors group-hover:text-white">
									#{tag}
								</span>
								{/* è®¡æ•°éƒ¨åˆ†ï¼šæ·¡ç´«è‰²èƒŒæ™¯ï¼Œæ— è¾¹æ¡† */}
								<span class="rounded-full bg-[#8953d1]/10 px-1.5 font-mono text-[10px] text-[#8953d1]/70 transition-colors group-hover:bg-white/20 group-hover:text-white">
									{count}
								</span>
							</a>
						</li>
					))
				}
			</ul>
		</aside>
	</div>
</PageLayout>

---
import type { CollectionEntry } from "astro:content";
import type { GetStaticPaths, Page } from "astro";
import { getAllPosts, groupPostsByYear } from "@/data/post"; // 删除了 getUniqueTags
import PageLayout from "@/layouts/Base.astro";
import { collectionDateSort } from "@/utils/date";

export const getStaticPaths = (async ({ paginate }) => {
	const MAX_POSTS_PER_PAGE = 99;
	const allPosts = await getAllPosts();
	const allPostsByDate = allPosts.sort(collectionDateSort);

	// 1. 计算每个标签出现的次数
	const tagCounts = allPosts.reduce<{ [key: string]: number }>((acc, post) => {
		post.data.tags?.forEach((tag) => {
			acc[tag] = (acc[tag] || 0) + 1;
		});
		return acc;
	}, {});

	// 2. 提取标签并按文章数量降序排列（可选）
	const uniqueTagsWithCounts = Object.entries(tagCounts)
		.sort((a, b) => b[1] - a[1]) // 按数量从多到少排序
		.slice(0, 15); // 只显示前 15 个热门标签

	return paginate(allPostsByDate, {
		pageSize: MAX_POSTS_PER_PAGE,
		props: { uniqueTagsWithCounts },
	});
}) satisfies GetStaticPaths;

interface Props {
	page: Page<CollectionEntry<"post">>;
	uniqueTagsWithCounts: [string, number][];
}

const { page, uniqueTagsWithCounts } = Astro.props;

const meta = {
	description: "Read my full archive of posts organized by year.",
	title: "Archive",
};

const groupedByYear = groupPostsByYear(page.data);
const descYearKeys = Object.keys(groupedByYear).sort((a, b) => +b - +a);
---

<PageLayout meta={meta}>
	<div class="mb-12">
		<h1 class="font-serif text-3xl font-bold dark:text-white">Archive</h1>
	</div>

	<div class="grid sm:grid-cols-[3fr_1fr] sm:gap-x-12 sm:gap-y-16">
		<div>
			{/* 文章列表部分保持之前的简洁样式... */}
			{
				descYearKeys.map((yearKey) => (
					<section class="mb-12">
						<h2 class="mb-6 border-b border-dashed border-gray-200 pb-2 font-mono text-xs font-bold tracking-widest text-gray-400 uppercase">
							{yearKey}
						</h2>
						<ul class="space-y-6 text-start">
							{groupedByYear[yearKey]?.map((p) => (
								<li class="flex flex-col">
									<div class="flex items-baseline justify-between gap-x-4">
										<a
											href={`/posts/${p.id}/`}
											class="font-serif text-xl font-medium text-black decoration-gray-400 underline-offset-4 hover:underline"
										>
											{p.data.title}
										</a>
										<time class="shrink-0 font-mono text-xs text-gray-400">
											{p.data.publishDate.toLocaleDateString("en-US", {
												month: "short",
												day: "numeric",
											})}
										</time>
									</div>
								</li>
							))}
						</ul>
					</section>
				))
			}
		</div>

		{/* 右侧 Tags 侧边栏：显示统计数字 */}
		<aside class="self-start sm:sticky sm:top-24">
			<h2 class="mb-4 flex items-center gap-2 font-serif text-lg font-bold dark:text-white">
				Tags
			</h2>
			<ul class="flex flex-wrap gap-x-2 gap-y-3">
				{
					uniqueTagsWithCounts.map(([tag, count]) => (
						<li>
							<a
								class="group flex items-center gap-x-1.5 rounded-md bg-gray-50 px-2 py-1 transition-all hover:bg-black hover:text-white dark:bg-zinc-800/50"
								href={`/tags/${tag}/`}
							>
								<span class="font-mono text-xs text-gray-600 group-hover:text-white">#{tag}</span>
								<span class="rounded-full bg-gray-200 px-1.5 font-mono text-[10px] text-gray-500 group-hover:bg-zinc-800 group-hover:text-gray-300 dark:bg-zinc-700">
									{count}
								</span>
							</a>
						</li>
					))
				}
			</ul>
		</aside>
	</div>
</PageLayout>

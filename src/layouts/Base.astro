---
import BaseHead from "@/components/BaseHead.astro";
import Footer from "@/components/layout/Footer.astro";
import Header from "@/components/layout/Header.astro";
import SkipLink from "@/components/SkipLink.astro";
import ThemeProvider from "@/components/ThemeProvider.astro";
import { ClientRouter } from "astro:transitions";
import { siteConfig } from "@/site.config";
import type { SiteMeta } from "@/types";

interface Props {
	meta: SiteMeta;
}

const {
	meta: { articleDate, description = siteConfig.description, ogImage, title },
} = Astro.props;

const GA_ID = "G-1EC76EZ517";
---

<html class="scroll-smooth" lang={siteConfig.lang}>
	<head>
		<BaseHead articleDate={articleDate} description={description} ogImage={ogImage} title={title} />
		<link rel="icon" href="/avatar.png" type="image/png" />
		<link rel="apple-touch-icon" href="/avatar.png" />
		<ClientRouter />

		<script is:inline async src={`https://www.googletagmanager.com/gtag/js?id=${GA_ID}`}></script>
		<script is:inline define:vars={{ GA_ID }}>
			window.dataLayer = window.dataLayer || [];
			function gtag() {
				dataLayer.push(arguments);
			}
			gtag("js", new Date());
			gtag("config", GA_ID);
		</script>
	</head>
	<body
		class="bg-global-bg text-global-text mx-auto flex min-h-screen max-w-4xl flex-col px-4 pt-8 font-mono text-sm font-normal antialiased sm:px-8"
	>
		<ThemeProvider />
		<SkipLink />
		<Header />
		<main id="main">
			<slot />
		</main>
		<Footer />

		{/* æ’­æ”¾å™¨ç»„ä»¶ï¼šä¿æŒå“ç‰Œç´«ä¸è¡¬çº¿ä½“ä¼˜é›…æ„Ÿ */}
		<div
			id="minimal-player"
			transition:persist
			class="fixed bottom-12 left-6 z-50 flex items-center sm:bottom-8 sm:left-8"
		>
			<div
				id="player-container"
				class="flex w-10 items-center overflow-hidden rounded-full bg-white p-1 shadow-md transition-all duration-500 ease-in-out dark:bg-[#1a1a1a] dark:shadow-none"
			>
				<button
					id="play-button"
					class="relative flex h-8 w-8 shrink-0 items-center justify-center rounded-full bg-white transition-transform active:scale-90"
				>
					<svg
						id="music-icon"
						class="text-[#8953d1] transition-opacity duration-300"
						xmlns="http://www.w3.org/2000/svg"
						width="16"
						height="16"
						viewBox="0 0 24 24"
						fill="none"
						stroke="currentColor"
						stroke-width="2.5"
						stroke-linecap="round"
						stroke-linejoin="round"
					>
						<path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle
							cx="18"
							cy="16"
							r="3"></circle>
					</svg>
					<div
						id="visualizer"
						class="absolute inset-0 flex items-center justify-center gap-[2px] opacity-0 transition-opacity duration-300"
					>
						<div class="bar h-1 w-[2px] rounded-full bg-[#8953d1]"></div>
						<div class="bar h-3 w-[2px] rounded-full bg-[#8953d1]"></div>
						<div class="bar h-2 w-[2px] rounded-full bg-[#8953d1]"></div>
					</div>
				</button>
				<div
					id="expanded-controls"
					class="pointer-events-none flex items-center pl-2 opacity-0 transition-opacity duration-300"
				>
					<div class="flex w-28 flex-col overflow-hidden whitespace-nowrap">
						<span class="font-serif text-[10px] font-bold tracking-wider text-[#8953d1] italic"
							>Now Playing</span
						>
						<div id="current-song-container">
							<span
								id="current-song-name"
								class="inline-block font-serif text-[12px] leading-tight font-medium text-gray-600 dark:text-gray-300"
								style="white-space: nowrap;"
							>
								Ready
							</span>
						</div>
					</div>
					<button
						id="next-button"
						class="ml-1 p-1 text-gray-400 transition-colors hover:text-[#8953d1]"
						title="Next"
					>
						<svg
							xmlns="http://www.w3.org/2000/svg"
							width="14"
							height="14"
							viewBox="0 0 24 24"
							fill="none"
							stroke="currentColor"
							stroke-width="2"
							stroke-linecap="round"
							stroke-linejoin="round"
							><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"
							></line></svg
						>
					</button>
					<button
						id="collapse-button"
						class="ml-1 p-1 text-gray-400 transition-colors hover:text-red-400"
						title="Collapse"
					>
						<svg
							xmlns="http://www.w3.org/2000/svg"
							width="14"
							height="14"
							viewBox="0 0 24 24"
							fill="none"
							stroke="currentColor"
							stroke-width="2"
							stroke-linecap="round"
							stroke-linejoin="round"><path d="M18 6L6 18M6 6l12 12"></path></svg
						>
					</button>
				</div>
			</div>
			<audio id="main-audio"></audio>
		</div>

		<style is:global>
			/* 1. æ’­æ”¾å™¨é€»è¾‘è¡¥å…¨ */
			.player-expanded #player-container {
				width: 230px !important;
				padding-right: 10px !important;
			}
			.player-expanded #expanded-controls {
				opacity: 1 !important;
				pointer-events: auto !important;
			}
			.is-playing #music-icon {
				opacity: 0 !important;
			}
			.is-playing #visualizer {
				opacity: 1 !important;
			}

			/* 2. å£°æ³¢åŠ¨ç”» */
			@keyframes quiet {
				25% {
					height: 4px;
				}
				50% {
					height: 10px;
				}
				75% {
					height: 4px;
				}
				100% {
					height: 10px;
				}
			}
			@keyframes loud {
				25% {
					height: 10px;
				}
				50% {
					height: 16px;
				}
				75% {
					height: 12px;
				}
				100% {
					height: 16px;
				}
			}
			.is-playing .bar:nth-child(1) {
				animation: quiet 0.8s infinite;
			}
			.is-playing .bar:nth-child(2) {
				animation: loud 1.2s infinite;
			}
			.is-playing .bar:nth-child(3) {
				animation: quiet 1s infinite;
			}

			/* 3. å…¨ç«™ Tags æ·±åº¦ç»Ÿä¸€ï¼šé€æ˜ + è‡ªåŠ¨é…è‰²æ–¹æ¡ˆ */
			.cactus-tag,
			.flex.flex-wrap.gap-2 a,
			aside ul.flex.flex-wrap a {
				display: inline-flex !important;
				align-items: center !important;
				border-radius: 0.375rem !important;
				padding: 0.25rem 0.5rem !important;
				font-size: 0.75rem !important;
				font-family: font-serif !important;
				/* ğŸŸ¢ æ ¸å¿ƒä¿®æ”¹ï¼šé¢œè‰²ç»§æ‰¿æ­£æ–‡ï¼ŒèƒŒæ™¯é€æ˜ï¼Œæ— è¾¹æ¡† */
				color: inherit !important;
				background-color: transparent !important;
				border: none !important;
				text-decoration: none !important;
				transition: all 0.2s ease !important;
				margin-bottom: 0.25rem;
				opacity: 0.8;
			}

			/* æ‚¬åœæ•ˆæœï¼šä¿æŒå“ç‰Œç´«ç‚¹äº®æ„Ÿ */
			.cactus-tag:hover,
			.flex.flex-wrap.gap-2 a:hover,
			aside ul.flex.flex-wrap a:hover {
				color: #8953d1 !important;
				background-color: rgba(137, 83, 209, 0.05) !important;
				transform: translateY(-1px) !important;
				opacity: 1;
			}

			/* æ ‡ç­¾è®¡æ•°æ•°å­—é€‚é… */
			.cactus-tag span,
			.flex.flex-wrap.gap-2 a span,
			aside ul.flex.flex-wrap a span:last-child {
				margin-left: 0.375rem;
				opacity: 0.4;
				font-size: 0.7rem;
				font-family: font-mono !important;
			}
			/* ğŸŸ¢ æ–°å¢ï¼šæ­Œæ›²åè·‘é©¬ç¯æ»šåŠ¨åŠ¨ç”» */
			@keyframes marquee {
				0% {
					transform: translateX(0);
				}
				100% {
					transform: translateX(-50%);
				} /* æ»šåŠ¨åˆ°ä¸€åŠï¼Œå› ä¸ºæˆ‘ä»¬ä¼šå¤åˆ¶ä¸€ä»½æ–‡å­—å®ç°æ— ç¼è¿æ¥ */
			}

			.animate-marquee {
				display: inline-block;
				white-space: nowrap;
				padding-left: 100%; /* åˆå§‹ä½ç½®åœ¨å³ä¾§å¤– */
				animation: marquee 10s linear infinite;
			}

			/* ä¿®æ”¹æ­Œæ›²åå®¹å™¨ï¼Œéšè—æº¢å‡ºéƒ¨åˆ† */
			#current-song-container {
				width: 110px; /* å›ºå®šæ˜¾ç¤ºå®½åº¦ */
				overflow: hidden;
				position: relative;
				mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
			}
		</style>

		<script is:inline>
			(function () {
				const playlist = [
					{ name: "I Will Fight For You - Voyageur", url: "/music/i-will-fight-for-you.mp3" },
					{ name: "Still Moving On - Luminar", url: "/music/still-moving-on.mp3" },
					{ name: "ä¸€èˆå€¾åŸ - é­å°æ¶µ", url: "/music/yiwuqingcheng.mp3" },
					{ name: "æ£è¡£ - å¤ç´é¾šä¸€", url: "/music/daoyi.mp3" },
					{ name: "ç»•æœˆ - å› ä½ è€Œåœ¨çš„æ¢¦", url: "/music/raoyue.mp3" },
					{ name: "ç©¿è¶Šæ—¶ç©ºçš„æ€å¿µ - å¤ç´æ¢…æ—¸", url: "/music/chuanyueshikong.mp3" },
					{ name: "ç¾äººå…® - å¤ç´èµµæ™“éœ", url: "/music/meirenxi.mp3" },
					{ name: "ä½™æƒ…å¹½æ¢¦ - éª†é›†ç›Š", url: "/music/yuqingyoumeng.mp3" },
					{ name: "Angel - Cathartic Fall", url: "/music/angel.mp3" },
					{ name: "Head In The Clouds - Hayd", url: "/music/head-in-the-clouds.mp3" },
					{ name: "å¤¢ç¯ç±  - RADWIMPS", url: "/music/mengdenglong.mp3" },
					{ name: "ä¸‰è‘‰ã®ãƒ†ãƒ¼ãƒ - RADWIMPS", url: "/music/sanye.mp3" },
				];
				let currentIndex = Math.floor(Math.random() * playlist.length);
				const state = { isPlaying: false, isExpanded: false };
				function updateUI() {
					const player = document.getElementById("minimal-player");
					const songName = document.getElementById("current-song-name");
					const container = document.getElementById("current-song-container");

					if (!player) return;

					// çŠ¶æ€æ›´æ–°
					state.isPlaying
						? player.classList.add("is-playing")
						: player.classList.remove("is-playing");
					state.isExpanded
						? player.classList.add("player-expanded")
						: player.classList.remove("player-expanded");

					if (songName && playlist[currentIndex]) {
						const name = playlist[currentIndex].name;
						songName.innerText = name;

						// ğŸŸ¢ åŠ¨ç”»é€»è¾‘ï¼šåˆ¤æ–­æ–‡å­—å®½åº¦æ˜¯å¦è¶…è¿‡å®¹å™¨å®½åº¦
						// å»¶è¿Ÿä¸€å°ä¼šå„¿æ‰§è¡Œï¼Œç¡®ä¿ DOM å·²æ¸²æŸ“
						setTimeout(() => {
							if (songName.offsetWidth > container.offsetWidth) {
								// å¦‚æœå¤ªé•¿ï¼Œå¤åˆ¶ä¸€ä»½å†…å®¹å®ç°æ— ç¼æ»šåŠ¨ï¼Œå¹¶æ·»åŠ åŠ¨ç”»ç±»
								songName.innerHTML = `${name} &nbsp;&nbsp;&nbsp;&nbsp; ${name} &nbsp;&nbsp;&nbsp;&nbsp;`;
								songName.style.animation = "marquee 8s linear infinite";
							} else {
								songName.style.animation = "none";
							}
						}, 50);
					}
				}
				function initPlayer() {
					const playBtn = document.getElementById("play-button");
					const nextBtn = document.getElementById("next-button");
					const collapseBtn = document.getElementById("collapse-button");
					const audio = document.getElementById("main-audio");
					if (!playBtn || !audio) return;
					const playNext = () => {
						currentIndex = (currentIndex + 1) % playlist.length;
						audio.src = playlist[currentIndex].url;
						audio.play();
						state.isPlaying = true;
						updateUI();
					};
					playBtn.onclick = () => {
						if (!state.isExpanded) state.isExpanded = true;
						if (state.isPlaying) {
							audio.pause();
							state.isPlaying = false;
						} else {
							if (!audio.src) audio.src = playlist[currentIndex].url;
							audio.play().catch(() => {});
							state.isPlaying = true;
						}
						updateUI();
					};
					nextBtn.onclick = (e) => {
						e.stopPropagation();
						playNext();
					};
					collapseBtn.onclick = (e) => {
						e.stopPropagation();
						state.isExpanded = false;
						updateUI();
					};
					audio.onended = playNext;
					updateUI();
				}
				initPlayer();
				document.addEventListener("astro:after-swap", initPlayer);
				document.addEventListener("astro:page-load", updateUI);
			})();
		</script>
	</body>
</html>

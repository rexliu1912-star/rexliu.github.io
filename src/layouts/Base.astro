---
import BaseHead from "@/components/BaseHead.astro";
import Footer from "@/components/layout/Footer.astro";
import Header from "@/components/layout/Header.astro";
import SkipLink from "@/components/SkipLink.astro";
import ThemeProvider from "@/components/ThemeProvider.astro";
import { ClientRouter } from "astro:transitions";
import { siteConfig } from "@/site.config";
import type { SiteMeta } from "@/types";

interface Props {
	meta: SiteMeta;
}

const {
	meta: { articleDate, description = siteConfig.description, ogImage, title },
} = Astro.props;

const GA_ID = "G-1EC76EZ517";
---

<html class="scroll-smooth" lang={siteConfig.lang}>
	<head>
		<BaseHead articleDate={articleDate} description={description} ogImage={ogImage} title={title} />
		<link rel="icon" href="/avatar.png" type="image/png" />
		<link rel="apple-touch-icon" href="/avatar.png" />
		<ClientRouter />

		<script is:inline async src={`https://www.googletagmanager.com/gtag/js?id=${GA_ID}`}></script>
		<script is:inline define:vars={{ GA_ID }}>
			window.dataLayer = window.dataLayer || [];
			function gtag() {
				dataLayer.push(arguments);
			}
			gtag("js", new Date());
			gtag("config", GA_ID);
		</script>
	</head>
	<body
		class="bg-global-bg text-global-text mx-auto flex min-h-screen max-w-4xl flex-col px-4 pt-8 font-mono text-sm font-normal antialiased sm:px-8"
	>
		<ThemeProvider />
		<SkipLink />
		<Header />
		<main id="main">
			<slot />
		</main>
		<Footer />

		{/* æ’­æ”¾å™¨ç»„ä»¶ï¼šå·²ä¼˜åŒ–åŠ è½½ç­–ç•¥ä¸å®¡ç¾è§†è§‰ */}
		<div
			id="minimal-player"
			transition:persist
			class="fixed bottom-12 left-6 z-50 flex items-center sm:bottom-8 sm:left-8"
		>
			<div
				id="player-container"
				class="custom-glow flex h-10 w-10 items-center justify-start overflow-hidden rounded-full border border-[#8953d1]/40 bg-white/70 backdrop-blur-md transition-all duration-500 ease-in-out dark:border-[#8953d1]/30 dark:bg-[#1a1a1a]/70"
			>
				<button
					id="play-button"
					class="relative ml-1 flex h-8 w-8 shrink-0 items-center justify-center rounded-full bg-transparent transition-transform active:scale-95"
				>
					<svg
						id="music-icon"
						class="text-[#8953d1] transition-opacity duration-300"
						xmlns="http://www.w3.org/2000/svg"
						width="18"
						height="18"
						viewBox="0 0 24 24"
						fill="none"
						stroke="currentColor"
						stroke-width="2.2"
						stroke-linecap="round"
						stroke-linejoin="round"
					>
						<path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle
							cx="18"
							cy="16"
							r="3"></circle>
					</svg>
					<div
						id="visualizer"
						class="absolute inset-0 flex items-center justify-center gap-[2px] opacity-0 transition-opacity duration-300"
					>
						<div class="bar h-1 w-[2px] rounded-full bg-[#8953d1]"></div>
						<div class="bar h-3 w-[2px] rounded-full bg-[#8953d1]"></div>
						<div class="bar h-2 w-[2px] rounded-full bg-[#8953d1]"></div>
					</div>
				</button>
				<div
					id="expanded-controls"
					class="pointer-events-none flex items-center pl-2 opacity-0 transition-opacity duration-300"
				>
					<div class="flex w-28 flex-col overflow-hidden whitespace-nowrap">
						<span class="font-serif text-[8px] font-bold tracking-wider text-[#8953d1]/80 italic"
							>Now Playing</span
						>
						<div id="current-song-container">
							<span
								id="current-song-name"
								class="inline-block font-serif text-[12px] leading-tight font-medium text-gray-600 dark:text-gray-300"
								style="white-space: nowrap;"
							>
								Ready
							</span>
						</div>
					</div>
					<button
						id="next-button"
						class="ml-1 p-1 text-gray-400 transition-colors hover:text-[#8953d1]"
						title="Next"
					>
						<svg
							xmlns="http://www.w3.org/2000/svg"
							width="14"
							height="14"
							viewBox="0 0 24 24"
							fill="none"
							stroke="currentColor"
							stroke-width="2"
							stroke-linecap="round"
							stroke-linejoin="round"
							><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"
							></line></svg
						>
					</button>
					<button
						id="collapse-button"
						class="ml-1 p-1 text-gray-400 transition-colors hover:text-red-400"
						title="Collapse"
					>
						<svg
							xmlns="http://www.w3.org/2000/svg"
							width="14"
							height="14"
							viewBox="0 0 24 24"
							fill="none"
							stroke="currentColor"
							stroke-width="2"
							stroke-linecap="round"
							stroke-linejoin="round"><path d="M18 6L6 18M6 6l12 12"></path></svg
						>
					</button>
				</div>
			</div>
			{/* ğŸŸ¢ å…³é”®ä¿®æ”¹ï¼šæ·»åŠ  preload="none"ï¼Œå½»åº•é˜²æ­¢è‡ªåŠ¨ä¸‹è½½éŸ³é¢‘æµé‡ */}
			<audio id="main-audio" preload="none"></audio>
		</div>

		<style is:global>
			.custom-glow {
				box-shadow:
					0 4px 15px -3px rgba(137, 83, 209, 0.2),
					0 4px 6px -2px rgba(137, 83, 209, 0.1);
			}

			.is-playing #player-container {
				box-shadow:
					0 0 20px -5px rgba(137, 83, 209, 0.4),
					0 4px 6px -2px rgba(137, 83, 209, 0.1);
				border-color: rgba(137, 83, 209, 0.6) !important;
			}

			.player-expanded #player-container {
				width: 230px !important;
				padding-right: 12px !important;
			}
			.player-expanded #expanded-controls {
				opacity: 1 !important;
				pointer-events: auto !important;
			}
			.is-playing #music-icon {
				opacity: 0 !important;
			}
			.is-playing #visualizer {
				opacity: 1 !important;
			}

			@keyframes quiet {
				25% {
					height: 4px;
				}
				50% {
					height: 10px;
				}
				75% {
					height: 4px;
				}
				100% {
					height: 10px;
				}
			}
			@keyframes loud {
				25% {
					height: 10px;
				}
				50% {
					height: 16px;
				}
				75% {
					height: 12px;
				}
				100% {
					height: 16px;
				}
			}
			.is-playing .bar:nth-child(1) {
				animation: quiet 0.8s infinite;
			}
			.is-playing .bar:nth-child(2) {
				animation: loud 1.2s infinite;
			}
			.is-playing .bar:nth-child(3) {
				animation: quiet 1s infinite;
			}

			.cactus-tag,
			.flex.flex-wrap.gap-2 a,
			aside ul.flex.flex-wrap a {
				display: inline-flex !important;
				align-items: center !important;
				border-radius: 0.375rem !important;
				padding: 0.25rem 0.5rem !important;
				font-size: 0.75rem !important;
				font-family: font-serif !important;
				color: inherit !important;
				background-color: transparent !important;
				border: none !important;
				text-decoration: none !important;
				transition: all 0.2s ease !important;
				margin-bottom: 0.25rem;
				opacity: 0.8;
			}

			.cactus-tag:hover,
			.flex.flex-wrap.gap-2 a:hover,
			aside ul.flex.flex-wrap a:hover {
				color: #8953d1 !important;
				background-color: rgba(137, 83, 209, 0.05) !important;
				transform: translateY(-1px) !important;
				opacity: 1;
			}

			@keyframes marquee {
				0% {
					transform: translateX(0);
				}
				100% {
					transform: translateX(-50%);
				}
			}
			#current-song-container {
				width: 110px;
				overflow: hidden;
				position: relative;
				mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
			}
		</style>

		<script is:inline>
			(function () {
				const playlist = [
					{ name: "I Will Fight For You - Voyageur", url: "/music/i-will-fight-for-you.mp3" },
					{ name: "Still Moving On - Luminar", url: "/music/still-moving-on.mp3" },
					{ name: "ä¸€èˆå€¾åŸ - é­å°æ¶µ", url: "/music/yiwuqingcheng.mp3" },
					{ name: "æ£è¡£ - å¤ç´é¾šä¸€", url: "/music/daoyi.mp3" },
					{ name: "ç©¿è¶Šæ—¶ç©ºçš„æ€å¿µ - å¤ç´æ¢…æ—¸", url: "/music/chuanyueshikong.mp3" },
					{ name: "ç¾äººå…® - å¤ç´èµµæ™“éœ", url: "/music/meirenxi.mp3" },
					{ name: "Angel - Cathartic Fall", url: "/music/angel.mp3" },
					{ name: "Head In The Clouds - Hayd", url: "/music/head-in-the-clouds.mp3" },
					{ name: "å¤¢ç¯ç±  - RADWIMPS", url: "/music/mengdenglong.mp3" },
					{ name: "ä¸‰è‘‰ã®ãƒ†ãƒ¼ãƒ - RADWIMPS", url: "/music/sanye.mp3" },
				];
				let currentIndex = Math.floor(Math.random() * playlist.length);
				const state = { isPlaying: false, isExpanded: false };
				function updateUI() {
					const player = document.getElementById("minimal-player");
					const songName = document.getElementById("current-song-name");
					const container = document.getElementById("current-song-container");
					if (!player) return;

					state.isPlaying
						? player.classList.add("is-playing")
						: player.classList.remove("is-playing");
					state.isExpanded
						? player.classList.add("player-expanded")
						: player.classList.remove("player-expanded");

					if (songName && playlist[currentIndex]) {
						const name = playlist[currentIndex].name;
						songName.innerText = name;
						setTimeout(() => {
							if (songName.offsetWidth > container.offsetWidth) {
								songName.innerHTML = `${name} &nbsp;&nbsp;&nbsp;&nbsp; ${name} &nbsp;&nbsp;&nbsp;&nbsp;`;
								songName.style.animation = "marquee 8s linear infinite";
							} else {
								songName.style.animation = "none";
							}
						}, 50);
					}
				}
				function initPlayer() {
					const playBtn = document.getElementById("play-button");
					const nextBtn = document.getElementById("next-button");
					const collapseBtn = document.getElementById("collapse-button");
					const audio = document.getElementById("main-audio");
					if (!playBtn || !audio) return;

					const playNext = () => {
						currentIndex = (currentIndex + 1) % playlist.length;
						audio.src = playlist[currentIndex].url;
						audio.play().catch(() => {});
						state.isPlaying = true;
						updateUI();
					};

					playBtn.onclick = () => {
						if (!state.isExpanded) state.isExpanded = true;
						if (state.isPlaying) {
							audio.pause();
							state.isPlaying = false;
						} else {
							if (!audio.src) audio.src = playlist[currentIndex].url;
							audio.play().catch((e) => {
								console.error("Playback failed", e);
							});
							state.isPlaying = true;
						}
						updateUI();
					};

					nextBtn.onclick = (e) => {
						e.stopPropagation();
						playNext();
					};
					collapseBtn.onclick = (e) => {
						e.stopPropagation();
						state.isExpanded = false;
						updateUI();
					};

					// è‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€é¦–
					audio.onended = playNext;

					// ğŸŸ¢ å®¹é”™å¤„ç†ï¼šå¦‚æœå½“å‰æ­Œæ›²åŠ è½½å¤±è´¥ï¼ˆå¦‚ 404ï¼‰ï¼Œè‡ªåŠ¨è·³åˆ°ä¸‹ä¸€é¦–
					audio.onerror = () => {
						console.warn("Audio file failed to load, skipping...");
						playNext();
					};

					updateUI();
				}
				initPlayer();
				document.addEventListener("astro:after-swap", initPlayer);
				document.addEventListener("astro:page-load", updateUI);
			})();
		</script>
	</body>
</html>
